<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Routine Hub</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='35' cy='50' r='25' fill='%232563eb' opacity='0.8'/%3E%3Ccircle cx='50' cy='50' r='25' fill='%237c3aed' opacity='0.8'/%3E%3Ccircle cx='65' cy='50' r='25' fill='%23db2777' opacity='0.8'/%3E%3C/svg%3E">
    <style>
        :root { --daily: #2563eb; --weekly: #7c3aed; --monthly: #db2777; --bg: #f8fafc; }
        body { font-family: system-ui, sans-serif; background: var(--bg); padding: 20px; margin: 0; padding-bottom: 120px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 1.5rem; position: relative; }
        h2 { font-size: 1.2rem; margin: 0 0 1rem 0; display: flex; justify-content: space-between; align-items: center; }
        .date-label { font-size: 0.8rem; color: #64748b; font-weight: normal; }
        
        .task { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .task input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; }
        .task span { flex-grow: 1; }
        input:checked + span { text-decoration: line-through; color: #94a3b8; }

        /* Edit Mode Styles */
        .del-btn { color: #ef4444; cursor: pointer; padding: 5px; font-weight: bold; display: none; }
        .add-box { display: none; margin-top: 10px; gap: 5px; }
        .add-box input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .is-editing .del-btn, .is-editing .add-box { display: flex; }
        .is-editing .task input[type="checkbox"] { display: none; }

        .controls { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .btn-group { display: flex; gap: 10px; }
        .save-btn { background: #1e293b; color: white; border: none; padding: 12px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; }
        .edit-toggle { background: #f1f5f9; color: #475569; border: none; padding: 12px 20px; border-radius: 30px; cursor: pointer; }
        #unsavedText { color: #ef4444; font-size: 0.8rem; font-weight: 600; visibility: hidden; }
    </style>
</head>
<body id="bodyTag">

<div class="container">
    <div class="card daily" id="dailyCard">
        <h2>Daily <span class="date-label" id="dDate"></span></h2>
        <div id="dailyList"></div>
        <div class="add-box"><input type="text" placeholder="Add daily task..." onkeypress="handleKey(event, 'daily')"></div>
    </div>
    <div class="card weekly" id="weeklyCard">
        <h2>Weekly <span class="date-label" id="wDate"></span></h2>
        <div id="weeklyList"></div>
        <div class="add-box"><input type="text" placeholder="Add weekly task..." onkeypress="handleKey(event, 'weekly')"></div>
    </div>
    <div class="card monthly" id="monthlyCard">
        <h2>Monthly <span class="date-label" id="mDate"></span></h2>
        <div id="monthlyList"></div>
        <div class="add-box"><input type="text" placeholder="Add monthly task..." onkeypress="handleKey(event, 'monthly')"></div>
    </div>
</div>

<div class="controls">
    <div id="unsavedText">⚠️ Unsaved Changes</div>
    <div class="btn-group">
        <button class="edit-toggle" onclick="toggleEdit()">Edit List</button>
        <button class="save-btn" id="saveBtn" onclick="saveAll()">Save Everything</button>
    </div>
</div>

<script>
    const CONFIG = { username: "Vogez-Git", repo: "Repo1" };
    const todayStr = new Date().toISOString().split('T')[0];
    let state = { daily: {}, weekly: {}, monthly: {} };
    let isDirty = false;

    async function init() {
        document.getElementById('dDate').innerText = todayStr;
        await loadData();
        render();
    }

    async function loadData() {
        let data = await fetchFile(todayStr);
        if (!data) {
            // Check history logic (same as before)
            for (let i = 1; i <= 30; i++) {
                let prev = new Date(); prev.setDate(prev.getDate() - i);
                let prevData = await fetchFile(prev.toISOString().split('T')[0]);
                if (prevData) {
                    data = prevData;
                    // Reset daily, check week/month rollover...
                    Object.keys(data.daily).forEach(k => data.daily[k] = false);
                    break; 
                }
            }
        }
        state = data || { daily: {}, weekly: {}, monthly: {} };
    }

    async function fetchFile(date) {
        try {
            const r = await fetch(`https://raw.githubusercontent.com/${CONFIG.username}/${CONFIG.repo}/main/days/${date}.json?cb=${Date.now()}`);
            return r.ok ? await r.json() : null;
        } catch(e) { return null; }
    }

    function render() {
        ['daily','weekly','monthly'].forEach(cat => {
            const el = document.getElementById(cat+'List');
            el.innerHTML = '';
            Object.entries(state[cat]).forEach(([task, done]) => {
                const div = document.createElement('div');
                div.className = 'task';
                div.innerHTML = `
                    <input type="checkbox" ${done?'checked':''} onchange="markDirty(); state.${cat}['${task.replace(/'/g, "\\'")}']=this.checked">
                    <span>${task}</span>
                    <span class="del-btn" onclick="removeTask('${cat}', '${task.replace(/'/g, "\\'")}')">✕</span>
                `;
                el.appendChild(div);
            });
        });
    }

    function toggleEdit() {
        document.getElementById('bodyTag').classList.toggle('is-editing');
        const btn = document.querySelector('.edit-toggle');
        btn.innerText = btn.innerText === "Edit List" ? "Finish Editing" : "Edit List";
    }

    function handleKey(e, cat) {
        if (e.key === 'Enter' && e.target.value.trim() !== '') {
            state[cat][e.target.value.trim()] = false;
            e.target.value = '';
            markDirty();
            render();
        }
    }

    function removeTask(cat, task) {
        delete state[cat][task];
        markDirty();
        render();
    }

    function markDirty() {
        isDirty = true;
        document.getElementById('unsavedText').style.visibility = 'visible';
    }

    async function saveAll() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerText = "Saving...";
        try {
            const r = await fetch('/api/save', { method: 'POST', body: JSON.stringify({ tasks: state }) });
            if (r.ok) {
                isDirty = false;
                document.getElementById('unsavedText').style.visibility = 'hidden';
                btn.innerText = "Saved!";
                setTimeout(() => { btn.disabled = false; btn.innerText = "Save Everything"; }, 2000);
            }
        } catch (e) { alert("Save failed!"); btn.disabled = false; }
    }

    init();
</script>
</body>

</html>
