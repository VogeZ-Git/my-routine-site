<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Routine Hub</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --weekly: #7c3aed; --monthly: #db2777; }
        body { font-family: system-ui, sans-serif; background: var(--bg); padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        h2 { font-size: 1.2rem; margin-top: 0; display: flex; justify-content: space-between; }
        .date-label { font-size: 0.8rem; color: #64748b; font-weight: normal; }
        .task { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .task input { width: 18px; height: 18px; margin-right: 12px; }
        input:checked + span { text-decoration: line-through; color: #94a3b8; }
        .status-bar { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; display: none; }
        .daily h2 { color: var(--primary); }
        .weekly h2 { color: var(--weekly); }
        .monthly h2 { color: var(--monthly); }
    </style>
</head>
<body>

<div class="container">
    <div class="card daily">
        <h2>Daily <span class="date-label" id="dailyDate"></span></h2>
        <div id="dailyList">Loading...</div>
    </div>

    <div class="card weekly">
        <h2>Weekly <span class="date-label" id="weeklyDate"></span></h2>
        <div id="weeklyList">Loading...</div>
    </div>

    <div class="card monthly">
        <h2>Monthly <span class="date-label" id="monthlyDate"></span></h2>
        <div id="monthlyList">Loading...</div>
    </div>
</div>

<div class="status-bar" id="saveStatus">Saving to GitHub...</div>

<script>
    const CONFIG = {
        username: "Vogez-Git",
        repo: "Repo1",
        tasks: {
            daily: ["Wake up 6am", "Drink water", "Exercise", "Journal"],
            weekly: ["Review Finances", "Clean House", "Meal Prep"],
            monthly: ["Pay Rent", "Deep Clean Fridge", "Review Goals"]
        }
    };

    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    let state = { daily: {}, weekly: {}, monthly: {} };

    // Helper: Get ISO Week number
    function getWeek(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    async function init() {
        document.getElementById('dailyDate').innerText = todayStr;
        document.getElementById('weeklyDate').innerText = "Week " + getWeek(now);
        document.getElementById('monthlyDate').innerText = now.toLocaleString('default', { month: 'long' });

        await loadSmartData();
        renderAll();
    }

    async function loadSmartData() {
        // 1. Try to get today's data first
        let data = await fetchFile(todayStr);

        if (!data) {
            // 2. If today is empty, find the most recent previous entry (check last 30 days)
            for (let i = 1; i <= 30; i++) {
                let prevDate = new Date();
                prevDate.setDate(now.getDate() - i);
                const prevStr = prevDate.toISOString().split('T')[0];
                const prevData = await fetchFile(prevStr);

                if (prevData) {
                    data = prevData;
                    const lastDate = new Date(prevStr);

                    // RESET LOGIC
                    // If last save was a different week, reset weekly
                    if (getWeek(lastDate) !== getWeek(now) || lastDate.getFullYear() !== now.getFullYear()) {
                        Object.keys(data.weekly).forEach(k => data.weekly[k] = false);
                    }
                    // If last save was a different month, reset monthly
                    if (lastDate.getMonth() !== now.getMonth() || lastDate.getFullYear() !== now.getFullYear()) {
                        Object.keys(data.monthly).forEach(k => data.monthly[k] = false);
                    }
                    // Daily always resets
                    Object.keys(data.daily).forEach(k => data.daily[k] = false);
                    break;
                }
            }
        }

        // 3. Fallback if no history exists at all
        if (!data) {
            data = { daily: {}, weekly: {}, monthly: {} };
            CONFIG.tasks.daily.forEach(t => data.daily[t] = false);
            CONFIG.tasks.weekly.forEach(t => data.weekly[t] = false);
            CONFIG.tasks.monthly.forEach(t => data.monthly[t] = false);
        }

        state = data;
    }

    async function fetchFile(date) {
        try {
            const res = await fetch(`https://raw.githubusercontent.com/${CONFIG.username}/${CONFIG.repo}/main/days/${date}.json?nocache=${Math.random()}`);
            return res.ok ? await res.json() : null;
        } catch (e) { return null; }
    }

    // ... Keep renderSection and update functions from previous version ...
    function renderAll() {
        renderSection('dailyList', state.daily, 'daily');
        renderSection('weeklyList', state.weekly, 'weekly');
        renderSection('monthlyList', state.monthly, 'monthly');
    }

    function renderSection(id, data, type) {
        const cont = document.getElementById(id);
        cont.innerHTML = '';
        Object.entries(data).forEach(([task, done]) => {
            const el = document.createElement('label');
            el.className = 'task';
            el.innerHTML = `<input type="checkbox" ${done ? 'checked' : ''} onchange="update('${type}', '${task}', this.checked)"><span>${task}</span>`;
            cont.appendChild(el);
        });
    }

    async function update(type, task, val) {
        state[type][task] = val;
        document.getElementById('saveStatus').style.display = 'block';
        await fetch('/api/save', {
            method: 'POST',
            body: JSON.stringify({ date: todayStr, tasks: state })
        });
        setTimeout(() => document.getElementById('saveStatus').style.display = 'none', 1000);
    }

    init();
</script>
</body>
</html>